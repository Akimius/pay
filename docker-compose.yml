#version: '3.8'  the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion

# Volumes are symlinks from a local machine to a docker resource
# in this instruction ${SRC}:/var/www/html - ./${SRC} is a relative path to the docker-compose file

# Network description helps isolate the project, each service must list it
networks:
  pay:
    name: pay

services:
#  Composer
  composer:
    image: composer:2.6.3
    container_name: ${PROJECT_NAME}_composer # container_name - overwrites the name pre-generated by the docker
    volumes:
      - ${SRC}:/var/www/html
    working_dir: /var/www/html
    networks:
      - pay

  # Redis
  redis:
    image: redis:latest
    container_name: ${PROJECT_NAME}_redis # container_name - overwrites the name pre-generated by the docker
    ports:
      - "6379:6379"
    networks:
      - pay

# PHP
  php:
    build:
      context: . # directory to search for, means current directory
      dockerfile: ./services/php/php.dockerfile
    container_name: ${PROJECT_NAME}_php # container_name - overwrites the name pre-generated by the docker
    volumes:
      - ${SRC}:/var/www/html
      - ./services/php/php-dev.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - pay
    environment:
      - PHP_IDE_CONFIG=serverName=${DEBUG_SERVER_NAME}

# PHP unit
  phpunit:
    build:
      context: .
      dockerfile: ./services/php/php.dockerfile
    container_name: phpunit
    volumes:
      - ${SRC}:/var/www/html
#      - ./services/php/php-dev.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    working_dir: /var/www/html
    entrypoint: ["/var/www/html/vendor/bin/phpunit"]
    networks:
      - pay

# Nginx
  # fastcgi_pass php:9000; in default.conf!!! php means php-container, 9000 - port number
  app:
    build:
      context: .
      dockerfile: ./services/nginx/nginx.dockerfile
    container_name: ${PROJECT_NAME}_nginx # container_name - overwrites the name pre-generated by the docker
    depends_on:
      - php
      - redis
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${SRC}:/var/www/html
    networks:
      - pay